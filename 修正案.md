# Rook Ceph PVC問題の修正案

## 問題の原因

Pod再起動時にSQLiteデータベース接続やファイルハンドルが適切にクローズされず、Rook Cephのマウント処理に影響している可能性があります。

## 修正案

### 1. app.py の修正

```python
def term():
    import rasp_shutter.control.scheduler

    rasp_shutter.control.scheduler.term()
    my_lib.webapp.log.term()

    # 子プロセスを終了
    my_lib.proc_util.kill_child()

    # プロセス終了 - os._exit()の代わりに通常のexitを使用
    logging.info("Graceful shutdown completed")
    sys.exit(0)  # os._exit(0) から変更
```

### 2. SQLite接続のクローズ処理強化

my_lib.webapp.log.py の get関数に try-finally を追加：

```python
def get(stop_day=0):
    sqlite = sqlite3.connect(get_db_path())
    try:
        sqlite.row_factory = lambda c, r: dict(zip([col[0] for col in c.description], r, strict=True))
        # 既存の処理...
        return log_list
    finally:
        sqlite.close()  # 確実にクローズ
```

### 3. ワーカースレッドの例外処理強化

worker関数でのtry-finally追加：

```python
def worker(log_queue):
    sqlite = sqlite3.connect(get_db_path())
    try:
        # 既存のwhileループ処理...
    finally:
        sqlite.close()  # 確実にクローズ
        logging.info("Terminate worker")
```

## 期待効果

- データベース接続の確実なクローズ
- Pythonのクリーンアップ処理の実行
- Rook Cephとの互換性向上

実装をご希望でしたら詳細な修正を行います。
